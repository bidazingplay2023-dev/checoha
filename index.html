<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ch√® C√¥ H√† (App Mode)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- C·∫§U TR√öC APP VIEW (FIXED HEIGHT) --- */
        * { box-sizing: border-box; }
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; /* Ch·∫∑n cu·ªôn to√†n trang */
            font-family: 'Roboto', sans-serif; 
            background-color: #f0f2f5; 
        }

        /* Container ch√≠nh: Chia l·ªõp theo chi·ªÅu d·ªçc */
        #ui-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 100%;
            margin: 0 auto;
        }

        /* 1. THANH T√åM KI·∫æM (LU√îN ·ªû TR√äN C√ôNG) */
        #top-bar {
            flex: 0 0 auto;
            padding: 8px 10px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            z-index: 10;
        }
        #search-box { 
            width: 100%; 
            padding: 10px 15px; 
            border: 1px solid #ddd; 
            border-radius: 20px; 
            font-size: 15px; 
            outline: none; 
            background: #f9f9f9;
        }
        #search-box:focus { background: #fff; border-color: #2196f3; }

        /* 2. KHU V·ª∞C GI·ªÆA (CH·ª®A MENU V√Ä CART TR√äN PC) */
        #main-split-view {
            flex: 1;
            display: flex;
            flex-direction: column; /* Mobile: D·ªçc */
            overflow: hidden; /* ƒê·ªÉ con cu·ªôn */
            position: relative;
        }

        /* KHU V·ª∞C MENU (CU·ªòN ƒê·ªòC L·∫¨P) */
        #left-panel {
            flex: 1; /* Chi·∫øm h·∫øt ph·∫ßn th·ª´a */
            overflow-y: auto; /* Cho ph√©p cu·ªôn danh s√°ch m√≥n */
            padding: 10px;
            background: #f0f2f5;
            -webkit-overflow-scrolling: touch;
        }

        /* KHU V·ª∞C GI·ªé H√ÄNG (C·ªê ƒê·ªäNH ·ªû ƒê√ÅY TR√äN MOBILE) */
        #right-panel {
            flex: 0 0 auto; /* Kh√¥ng co gi√£n t·ª± do, chi·ªÅu cao theo n·ªôi dung ho·∫∑c c·ªë ƒë·ªãnh */
            background: white;
            border-top: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
            z-index: 20;
            padding: 0;
        }

        /* --- CHI TI·∫æT GIAO DI·ªÜN --- */
        
        /* Menu */
        .menu-section { border-radius: 8px; padding: 8px; text-align: left; background: white; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.2s; }
        .bg-15k { background-color: #fffde7; border: 1px solid #fff9c4; } 
        .bg-20k { background-color: #e1f5fe; border: 1px solid #b3e5fc; } 
        .bg-high { background-color: #ffebee; border: 1px solid #ffcdd2; } 
        
        /* C·∫¨P NH·∫¨T: Header c√≥ th·ªÉ click */
        .section-title { 
            font-weight: 700; font-size: 13px; text-transform: uppercase; 
            margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; 
            color: #333; padding-left: 2px; 
            cursor: pointer; user-select: none;
        }
        .bg-15k .section-title { color: #f57f17; }
        .bg-20k .section-title { color: #01579b; }
        .bg-high .section-title { color: #b71c1c; }
        
        .toggle-icon { font-size: 14px; color: #666; font-weight: normal; }

        .group-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        
        /* N√∫t m√≥n ƒÉn: T·ªëi ∆∞u di·ªán t√≠ch */
        .btn-che { 
            width: 100%; min-height: 55px; padding: 4px; 
            background-color: #fff; color: #333; 
            border: 1px solid #eee; border-radius: 6px; 
            cursor: pointer; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; text-align: center; 
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
            position: relative; overflow: hidden;
        }
        .btn-che:active { background-color: #e3f2fd; border-color: #2196f3; transform: translateY(1px); }
        .che-name { font-size: 11px; font-weight: 700; line-height: 1.2; margin-bottom: 2px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .che-price { font-size: 10px; color: #555; font-weight: 500; background: #eee; padding: 1px 5px; border-radius: 4px; }

        /* Giao di·ªán Gi·ªè h√†ng (T·ªëi ∆∞u kh√¥ng gian) */
        #cart-container { 
            display: flex; 
            flex-direction: column; 
            max-height: 35vh; /* Gi·ªõi h·∫°n chi·ªÅu cao gi·ªè h√†ng tr√™n mobile ƒë·ªÉ kh√¥ng che h·∫øt menu */
            background: white;
        }
        
        #cart-header { 
            padding: 8px 10px; 
            background: #f8f9fa; 
            border-bottom: 1px solid #eee; 
            color: #444; 
            font-size: 13px; 
            font-weight: bold; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        
        #cart-list { 
            padding: 0 10px; 
            overflow-y: auto; /* Cu·ªôn ri√™ng ph·∫ßn danh s√°ch m√≥n ƒë√£ ch·ªçn */
            flex: 1; /* Chi·∫øm ph·∫ßn c√≤n l·∫°i c·ªßa cart container */
            min-height: 60px;
        }

        .cart-item { padding: 8px 0; border-bottom: 1px dashed #eee; }
        .item-row-top { display: flex; justify-content: space-between; align-items: center; }
        .item-left { display: flex; align-items: center; gap: 6px; width: 65%;}
        .item-qty-badge { background: #e3f2fd; color: #1565c0; font-weight: bold; padding: 1px 6px; border-radius: 4px; font-size: 12px; border: 1px solid #90caf9; min-width: 25px; text-align: center;}
        .item-name { font-weight: 700; font-size: 13px; color: #333; }
        .item-right { display: flex; align-items: center; gap: 4px; }
        .qty-btn { width: 24px; height: 24px; border-radius: 50%; border: 1px solid #ddd; background: #fff; color: #333; font-weight: bold; font-size: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .qty-btn:active { background: #ddd; }
        .delete-btn { color: white; background: #ef5350; width: 24px; height: 24px; border-radius: 4px; text-align: center; line-height: 24px; cursor: pointer; font-weight: bold; font-size: 12px; margin-left: 4px; }
        
        .option-row { font-size: 12px; color: #666; margin-top: 4px; display: flex; align-items: center; }
        .note-input { width: 100%; padding: 6px; margin-top: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; background: #fafafa; }

        /* Thanh ƒëi·ªÅu khi·ªÉn cu·ªëi c√πng (Total + Buttons) */
        #bottom-controls {
            padding: 8px 10px;
            background: white;
            border-top: 1px solid #eee;
        }

        #total-bar { 
            background-color: #fff8e1; color: #f57f17; 
            padding: 8px 12px; font-size: 16px; font-weight: 700; 
            border-radius: 6px; margin-bottom: 8px; 
            border: 1px solid #ffe082; display: flex; justify-content: space-between; align-items: center; 
        }
        
        .action-row { display: flex; gap: 6px; margin-bottom: 0; }
        .action-btn { 
            flex: 1; padding: 10px; font-size: 14px; border: none; 
            border-radius: 6px; cursor: pointer; font-weight: bold; 
            text-transform: uppercase; box-shadow: 0 2px 3px rgba(0,0,0,0.1); 
            font-family: 'Roboto', sans-serif; 
        }
        .action-btn:active { opacity: 0.8; transform: scale(0.98); }
        #btn-print { background-color: #1976d2; color: white; flex: 2; font-size: 15px; }
        #btn-stats { background-color: #7b1fa2; color: white; flex: 1; }
        #btn-clear { background-color: #78909c; color: white; flex: 1; }
        
        .security-note { font-size: 10px; color: #aaa; text-align: center; margin-top: 5px; }

        /* --- RESPONSIVE: M√ÄN H√åNH M√ÅY T√çNH / TABLET --- */
        @media (min-width: 768px) {
            #main-split-view {
                flex-direction: row; /* Chuy·ªÉn th√†nh 2 c·ªôt ngang */
                max-width: 1200px;
                margin: 0 auto;
                width: 100%;
                padding: 15px;
                gap: 15px;
            }

            #top-bar { padding: 15px; text-align: center; border-bottom: none; background: #f0f2f5; }
            #search-box { max-width: 600px; padding: 15px; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

            #left-panel {
                flex: 2; /* Menu r·ªông g·∫•p ƒë√¥i cart */
                border-radius: 12px;
                background: transparent;
                padding-right: 5px;
            }
            
            #right-panel {
                flex: 1;
                height: 100%; /* Full chi·ªÅu cao khu v·ª±c gi·ªØa */
                border-radius: 12px;
                border: none;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
                max-width: 400px;
                overflow: hidden;
            }

            #cart-container {
                flex: 1; /* Cart list gi√£n h·∫øt m·ª©c c√≥ th·ªÉ tr√™n PC */
                max-height: none; 
            }
            
            #cart-list { max-height: none; } /* PC kh√¥ng gi·ªõi h·∫°n chi·ªÅu cao list */
            
            .group-grid { grid-template-columns: repeat(4, 1fr); gap: 10px; }
            .btn-che { min-height: 80px; padding: 10px; }
            .che-name { font-size: 14px; margin-bottom: 5px; }
            .che-price { font-size: 13px; }
        }

        /* --- M√ÄN H√åNH R·∫§T NH·ªé --- */
        @media (max-width: 360px) {
            .group-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* --- MODAL CSS (Gi·ªØ nguy√™n) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 90%; max-width: 450px; border-radius: 12px; padding: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: left; max-height: 85vh; display: flex; flex-direction: column; }
        .modal-title { font-size: 16px; font-weight: bold; margin-bottom: 10px; text-align: center; color: #333; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        .confirm-list { overflow-y: auto; margin-bottom: 10px; flex-grow: 1; border: 1px solid #f0f0f0; border-radius: 6px; padding: 8px; background: #fafafa;}
        .confirm-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed #ddd; padding-bottom: 6px; font-size: 13px;}
        .confirm-total { font-size: 16px; font-weight: bold; color: #d32f2f; text-align: right; margin-bottom: 10px; }
        .modal-btn-group { display: flex; gap: 8px; margin-top: auto;}
        .modal-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; text-transform: uppercase; }
        .btn-confirm { background: #43a047; color: white; }
        .btn-cancel { background: #bdbdbd; color: #333; }

        /* --- TABS CSS (Gi·ªØ nguy√™n) --- */
        .tabs-container { display: flex; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 8px 0; border: none; background: #f5f5f5; cursor: pointer; font-size: 11px; font-weight: bold; color: #666; border-right: 1px solid #ddd; }
        .tab-btn:last-child { border-right: none; }
        .tab-btn.active { background: #1976d2; color: white; }
        .stat-display-area { text-align: center; padding: 5px 0 15px 0; }
        .stat-big-value { font-size: 32px; font-weight: 900; color: #1565c0; margin-bottom: 5px; }
        .stat-label { font-size: 13px; color: #777; font-style: italic; }
        #date-picker-area { margin-top: 10px; display: none; flex-direction: column; align-items: center; gap: 8px;}
        .date-input { padding: 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; width: 70%; text-align: center;}
        .btn-search-date { padding: 8px 20px; background: #ff9800; color: white; border: none; border-radius: 6px; font-weight: bold; }
        .stat-count-info { font-size: 12px; color: #999; margin-top: 10px; border-top: 1px dashed #eee; padding-top: 8px;}
        #loading { display:none; color: #666; font-style: italic; text-align: center; margin-bottom: 10px; font-size: 12px;}

        /* --- TOAST & PRINT --- */
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #323232; color: #fff; text-align: center; border-radius: 4px; padding: 12px; position: fixed; z-index: 1000; left: 50%; bottom: 80px; font-size: 14px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        
        @media print {
            @page { margin: 0; } 
            body { margin: 0; padding: 0; background: white; overflow: visible; height: auto; } 
            #ui-container, .modal-overlay, #toast, .security-note { display: none !important; }
            #print-section { display: block !important; width: 100%; background-color: white; }
            .sticker { width: 100%; padding: 1mm 0; display: flex; flex-direction: column; justify-content: center; align-items: center; page-break-after: always; break-after: page; }
            .sticker-name { font-family: 'Roboto', Arial, sans-serif !important; font-size: 22px; font-weight: 900; text-transform: uppercase; line-height: 1; text-align: center; color: #000; }
            .sticker-custom-note { font-family: 'Roboto', Arial, sans-serif !important; font-size: 15px; font-weight: bold; background-color: #000; color: #fff !important; padding: 2px 8px; border-radius: 4px; margin-top: 3px; text-align: center; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <div id="ui-container">
        <!-- TOP BAR: SEARCH -->
        <div id="top-bar">
            <input type="text" id="search-box" placeholder="üîç T√¨m nhanh (g√µ t√™n m√≥n)..." onkeyup="filterMenu()">
        </div>

        <!-- SPLIT VIEW: MENU (SCROLL) & CART (FIXED) -->
        <div id="main-split-view">
            <!-- LEFT PANEL: MENU -->
            <div id="left-panel">
                <div id="menu-area"></div>
                <!-- Spacer ƒë·ªÉ n·ªôi dung cu·ªëi kh√¥ng b·ªã che tr√™n m·ªôt s·ªë m√°y -->
                <div style="height: 20px;"></div> 
            </div>

            <!-- RIGHT PANEL: CART & CONTROLS -->
            <div id="right-panel">
                <div id="cart-container">
                    <div id="cart-header">
                        <span><span style="font-size:16px">üõí</span> ƒê∆°n ƒëang ch·ªçn</span>
                        <span style="background:#e3f2fd; color:#1565c0; padding:2px 8px; border-radius:10px; font-size:12px;">SL: <b id="count-display">0</b></span>
                    </div>
                    <div id="cart-list">
                        <div style="text-align:center; padding: 15px; color:#aaa; font-size:12px; font-style:italic;">
                            Ch∆∞a ch·ªçn m√≥n n√†o<br>H√£y b·∫•m v√†o menu ·ªü tr√™n
                        </div>
                    </div>
                </div>

                <div id="bottom-controls">
                    <div id="total-bar"><span>T·ªîNG TI·ªÄN:</span><span id="total-price" style="font-size:20px;">0k</span></div>
                    <div class="action-row">
                        <button id="btn-print" class="action-btn" onclick="showConfirmDialog()">üñ®Ô∏è IN & L∆ØU</button>
                    </div>
                    <div class="action-row" style="margin-top:6px;">
                        <button id="btn-stats" class="action-btn" onclick="askPassword()">üìä Th·ªëng k√™</button>
                        <button id="btn-clear" class="action-btn" onclick="clearCart()">üóëÔ∏è X√≥a m·ªõi</button>
                    </div>
                    <div class="security-note">D·ªØ li·ªáu ƒë∆∞·ª£c b·∫£o m·∫≠t b·ªüi Google</div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS & HIDDEN ELEMENTS (Gi·ªØ nguy√™n logic) -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">X√ÅC NH·∫¨N ƒê∆†N H√ÄNG</div>
            <div id="confirm-list" class="confirm-list"></div>
            <div id="confirm-total" class="confirm-total">T·ªïng: 0k</div>
            <div class="modal-btn-group">
                <button class="modal-btn btn-cancel" onclick="closeModal('confirm-modal')">S·ª≠a l·∫°i</button>
                <button class="modal-btn btn-confirm" onclick="processPrintAndSave()">‚úÖ IN NGAY</button>
            </div>
        </div>
    </div>

    <div id="stats-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">DOANH THU</div>
            <div id="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            <div id="stats-content" style="display:none;">
                <div class="tabs-container">
                    <button class="tab-btn active" id="tab-today" onclick="switchTab('today')">H√îM NAY</button>
                    <button class="tab-btn" id="tab-month" onclick="switchTab('month')">TH√ÅNG</button>
                    <button class="tab-btn" id="tab-year" onclick="switchTab('year')">NƒÇM</button>
                    <button class="tab-btn" id="tab-custom" onclick="switchTab('custom')">KH√ÅC</button>
                </div>
                <div class="stat-display-area">
                    <div class="stat-big-value" id="display-value">0k</div>
                    <div class="stat-label" id="display-label">Doanh thu H√¥m nay</div>
                    <div id="date-picker-area">
                        <input type="date" id="date-input" class="date-input">
                        <button class="btn-search-date" onclick="lookupDate()">üîç Tra c·ª©u</button>
                    </div>
                    <div class="stat-count-info">T·ªïng ƒë∆°n ƒë√£ in: <b id="stat-count" style="color:#333">0</b></div>
                </div>
            </div>
            <div class="modal-btn-group">
                <button class="modal-btn btn-cancel" onclick="closeModal('stats-modal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <div id="toast">ƒê√£ l∆∞u v√†o Google Sheet!</div>
    <div id="print-section"></div>

    <script>
        const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz4hKNgQCElUaM7ShRFSka1bjGnNqVPdOTHrGgbz2fmxrro1oroSeiu_QwPetGtGNBC/exec";
        
        var menu = [
            { name: "Ch√® B∆∞·ªüi", price: 15000 }, { name: "Ch√® ƒê·∫≠u ƒê·ªè", price: 15000 }, { name: "Ch√® ƒê·∫≠u ƒêen", price: 15000 },
            { name: "Ch√® ƒê·∫≠u Xanh", price: 15000 }, { name: "Ch√® Th·∫≠p C·∫©m", price: 15000 }, { name: "Ch√® Ng√¥ C·ªët D·ª´a", price: 15000 },
            { name: "Ch√® C·ªëm D·ª´a Non", price: 15000 }, { name: "Ch√® D·ª´a D·∫ßm", price: 15000 }, { name: "Ch√® Khoai D·∫ªo", price: 15000 },
            { name: "Ch√® Tu·ªïi Th∆°", price: 15000 }, { name: "S∆∞∆°ng Sa H·∫°t L·ª±u", price: 15000 }, { name: "SC Tr√¢n Ch√¢u", price: 15000 },
            { name: "Th·∫≠p C·∫©m ƒêB", price: 20000 }, { name: "S·ªØa Chua M√≠t", price: 20000 }, { name: "SC D·ª´a Non", price: 20000 },
            { name: "SC C·ªëm D·ª´a Non", price: 20000 }, { name: "Ch√® S·∫ßu", price: 25000 }, { name: "S·∫ßu Ri√™ng ƒê.Xanh", price: 25000 }, 
            { name: "Ch√® H·∫°t ƒê√°c", price: 25000 }, { name: "SC M√≠t H·∫°t ƒê√°c", price: 25000 }, { name: "Ch√® Th·ªët N·ªët", price: 25000 },
            { name: "SC M√≠t S·∫ßu Ri√™ng", price: 35000 }
        ];

        var cart = []; 
        var currentStats = { today: 0, month: 0, year: 0, count: 0 };
        var globalPassword = ""; 

        function formatK(price) { return (price / 1000) + "k"; }
        
        // --- C·∫¨P NH·∫¨T RENDER MENU (ACCORDION) ---
        function renderMenu(items) {
            var container = document.getElementById('menu-area'); container.innerHTML = ''; 
            var list15 = items.filter(i => i.price === 15000); 
            var list20 = items.filter(i => i.price === 20000); 
            var listHigh = items.filter(i => i.price >= 25000);
            
            // Logic: N·∫øu ƒëang t√¨m ki·∫øm (s·ªë l∆∞·ª£ng hi·ªÉn th·ªã < t·ªïng), m·ªü h·∫øt. 
            // N·∫øu kh√¥ng t√¨m ki·∫øm (full menu), ch·ªâ m·ªü nh√≥m ƒë·∫ßu ti√™n (15K).
            var isSearchMode = (items.length !== menu.length);

            function createSection(list, bgClass, title, defaultOpen) {
                if(list.length === 0) return;
                var section = document.createElement('div'); section.className = 'menu-section ' + bgClass;
                
                var header = document.createElement('div'); 
                header.className = 'section-title'; 
                // Bi·ªÉu t∆∞·ª£ng: ‚ñº n·∫øu m·ªü, ‚ñ∂ n·∫øu ƒë√≥ng
                var iconChar = defaultOpen ? '‚ñº' : '‚ñ∂';
                var displayStyle = defaultOpen ? 'grid' : 'none';
                
                header.innerHTML = `<span>${title}</span><span class="toggle-icon">${iconChar}</span>`;
                
                var grid = document.createElement('div'); 
                grid.className = 'group-grid';
                grid.style.display = displayStyle; // Set tr·∫°ng th√°i ban ƒë·∫ßu

                // Th√™m s·ª± ki·ªán click ƒë·ªÉ ·∫©n/hi·ªán
                header.onclick = function() {
                    var ic = header.querySelector('.toggle-icon');
                    if (grid.style.display === 'none') {
                        grid.style.display = 'grid';
                        ic.innerText = '‚ñº';
                    } else {
                        grid.style.display = 'none';
                        ic.innerText = '‚ñ∂';
                    }
                };

                list.forEach(item => {
                    var btn = document.createElement('div'); btn.className = 'btn-che';
                    btn.innerHTML = `<span class="che-name">${item.name}</span><span class="che-price">${formatK(item.price)}</span>`;
                    btn.onclick = function() { addToCart(item); }; grid.appendChild(btn);
                });
                section.appendChild(header); section.appendChild(grid); container.appendChild(section);
            }
            
            // G·ªçi h√†m t·∫°o section v·ªõi tham s·ªë defaultOpen
            // Nh√≥m 15K: M·ªü n·∫øu l√† t√¨m ki·∫øm HO·∫∂C lu√¥n m·ªü m·∫∑c ƒë·ªãnh (true)
            createSection(list15, 'bg-15k', '15K - ƒê·ªíNG GI√Å', true); 
            // Nh√≥m 20K & 25K: Ch·ªâ m·ªü khi ƒëang t√¨m ki·∫øm (isSearchMode)
            createSection(list20, 'bg-20k', '20K - ƒê·ªíNG GI√Å', isSearchMode); 
            createSection(listHigh, 'bg-high', '25K+ (CAO C·∫§P)', isSearchMode);
        }
        renderMenu(menu);

        function filterMenu() {
            var keyword = document.getElementById('search-box').value.toLowerCase();
            var filtered = menu.filter(item => item.name.toLowerCase().indexOf(keyword) > -1); renderMenu(filtered);
        }
        
        // --- CH·ª®C NƒÇNG CU·ªòN CART ---
        function scrollCartToBottom() {
            var el = document.getElementById('cart-list');
            el.scrollTop = el.scrollHeight;
        }

        function addToCart(item) {
            var foundIndex = -1; for(var i=0; i<cart.length; i++) { if(cart[i].name === item.name && cart[i].note === "") { foundIndex = i; break; } }
            if(foundIndex !== -1) cart[foundIndex].quantity++; else cart.push({ name: item.name, price: item.price, note: "", quantity: 1 });
            document.getElementById('search-box').value = ''; 
            renderMenu(menu); 
            renderCart();
            // T·ª± ƒë·ªông cu·ªôn xu·ªëng m√≥n v·ª´a th√™m
            setTimeout(scrollCartToBottom, 100);
        }
        
        window.changeQty = function(index, delta) { cart[index].quantity += delta; if (cart[index].quantity <= 0) removeFromCart(index); else renderCart(); }
        function removeFromCart(index) { cart.splice(index, 1); renderCart(); }
        function clearCart() { cart = []; renderCart(); document.getElementById('search-box').value = ''; renderMenu(menu); }
        window.updateNoteData = function(index, val) { if (cart[index]) cart[index].note = val; }
        
        window.toggleNoteView = function(index, checkbox) {
            var item = cart[index];
            if (checkbox.checked) {
                if (item.quantity > 1) {
                    item.quantity--; var newItem = { name: item.name, price: item.price, note: "", quantity: 1 };
                    cart.splice(index + 1, 0, newItem); renderCart();
                    var newIndex = index + 1;
                    setTimeout(() => {
                        var inputs = document.querySelectorAll('.option-row input[type="text"]'); 
                        // T√¨m input ƒë√∫ng c·ªßa item m·ªõi
                        var input = document.getElementById('input-' + newIndex);
                        if(input) {
                            input.parentNode.style.display = 'block';
                            input.focus();
                            // Hack checkbox hi·ªÉn th·ªã
                            var cbs = document.querySelectorAll('input[type="checkbox"]');
                            if(cbs[newIndex]) cbs[newIndex].checked = true;
                        }
                    }, 50); checkbox.checked = false;
                } else { document.getElementById('note-box-' + index).style.display = 'block'; document.getElementById('input-' + index).focus(); }
            } else { document.getElementById('note-box-' + index).style.display = 'none'; updateNoteData(index, ""); document.getElementById('input-' + index).value = ""; }
        }

        function renderCart() {
            var listDiv = document.getElementById('cart-list'); var countDisplay = document.getElementById('count-display'); var totalDisplay = document.getElementById('total-price');
            var totalMoney = 0; var totalCups = 0;
            for(var k=0; k<cart.length; k++) { totalMoney += (cart[k].price * cart[k].quantity); totalCups += cart[k].quantity; }
            countDisplay.innerText = totalCups; totalDisplay.innerText = formatK(totalMoney);
            if (cart.length === 0) { listDiv.innerHTML = '<div style="text-align:center; padding: 15px; color:#aaa; font-size:12px; font-style:italic;">Ch∆∞a ch·ªçn m√≥n n√†o<br>H√£y b·∫•m v√†o menu ·ªü tr√™n</div>'; return; }
            var htmlString = '';
            for (var i = 0; i < cart.length; i++) {
                var item = cart[i]; var hasNote = (item.note && item.note.trim() !== ""); var checkedStr = hasNote ? "checked" : ""; var displayStr = hasNote ? "block" : "none";
                htmlString += `<div class="cart-item"><div class="item-row-top"><div class="item-left"><span class="item-qty-badge">x${item.quantity}</span><span class="item-name">${item.name}</span></div>
                    <div class="item-right"><div class="qty-btn" onclick="changeQty(${i}, -1)">-</div><div class="qty-btn" onclick="changeQty(${i}, 1)">+</div><div class="delete-btn" onclick="removeFromCart(${i})">‚úï</div></div></div>
                    <div class="option-row"><label style="display:flex; align-items:center; width:100%; cursor:pointer;"><input type="checkbox" ${checkedStr} onchange="toggleNoteView(${i}, this)" style="margin-right:5px;"> Ghi ch√∫</label></div>
                    <div id="note-box-${i}" style="display: ${displayStr};"><input type="text" id="input-${i}" class="note-input" placeholder="Nh·∫≠p ghi ch√∫..." value="${item.note}" oninput="updateNoteData(${i}, this.value)"></div></div>`;
            } listDiv.innerHTML = htmlString;
        }

        function showConfirmDialog() {
            if (cart.length === 0) { alert("Ch∆∞a ch·ªçn m√≥n n√†o!"); return; }
            var list = document.getElementById('confirm-list'); var total = document.getElementById('confirm-total');
            var html = ''; var finalTotal = 0;
            cart.forEach(item => {
                var subTotal = item.price * item.quantity; finalTotal += subTotal;
                var noteText = (item.note) ? `<br><small style="color:red; font-style:italic;">(${item.note})</small>` : '';
                html += `<div class="confirm-row"><div style="flex:1;"><b>x${item.quantity}</b> ${item.name} ${noteText}</div><div style="font-weight:bold;">${formatK(subTotal)}</div></div>`;
            });
            list.innerHTML = html; total.innerText = "T·ªïng: " + formatK(finalTotal);
            document.getElementById('confirm-modal').style.display = 'flex';
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- G·ª¨I D·ªÆ LI·ªÜU ---
        function sendToGoogleSheet(totalMoney) {
            var orderDetails = cart.map(item => `(${item.quantity}) ${item.name} ${item.note ? '['+item.note+']' : ''}`).join(", ");
            var data = { action: 'save', order_details: orderDetails, total_money: totalMoney };
            fetch(GOOGLE_APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
            .then(() => { var x = document.getElementById("toast"); x.className = "show"; setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000); })
            .catch(err => console.error(err));
        }

        // --- X·ª¨ L√ù IN & L∆ØU & X√ìA ƒê∆†N ---
        function processPrintAndSave() {
            var totalMoney = 0; 
            cart.forEach(i => totalMoney += (i.price * i.quantity));
            closeModal('confirm-modal');
            var printSection = document.getElementById('print-section'); 
            printSection.innerHTML = ''; 
            var printHTML = '';
            cart.forEach(item => {
                var notePart = (item.note && item.note.trim() !== "") ? `<span class="sticker-custom-note">${item.note}</span>` : '';
                for (var q = 0; q < item.quantity; q++) { printHTML += `<div class="sticker"><span class="sticker-name">${item.name}</span>${notePart}</div>`; }
            });
            printSection.innerHTML = printHTML; 
            
            setTimeout(() => { 
                window.print(); 
                setTimeout(() => {
                    var isPrinted = confirm("üñ®Ô∏è X√ÅC NH·∫¨N:\n\nB·∫°n ƒë√£ in phi·∫øu th√†nh c√¥ng ch∆∞a?\n\n- B·∫•m [OK] ƒë·ªÉ L∆ØU DOANH THU & X√ìA ƒê∆†N.\n- B·∫•m [Cancel] n·∫øu b·∫°n h·ªßy in.");
                    if(isPrinted) {
                        sendToGoogleSheet(totalMoney); 
                        clearCart(); 
                    }
                }, 1000); 
            }, 500);
        }

        // --- TH·ªêNG K√ä ---
        function askPassword() {
            var pass = prompt("üîí Nh·∫≠p m·∫≠t kh·∫©u qu·∫£n l√Ω:", "");
            if (pass) {
                globalPassword = pass; 
                document.getElementById('stats-modal').style.display = 'flex';
                document.getElementById('loading').style.display = 'block';
                document.getElementById('stats-content').style.display = 'none';
                
                var data = { action: 'get_stats', password: pass };
                
                fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    document.getElementById('loading').style.display = 'none';
                    if (result.result === "success") {
                        currentStats = result;
                        document.getElementById('stats-content').style.display = 'block';
                        document.getElementById('stat-count').innerText = result.count + " ƒë∆°n";
                        switchTab('today');
                    } else {
                        alert("‚õî " + result.msg);
                        closeModal('stats-modal');
                    }
                })
                .catch(error => {
                    document.getElementById('loading').style.display = 'none';
                    alert("L·ªói: " + error);
                    closeModal('stats-modal');
                });
            }
        }

        function lookupDate() {
            var dateVal = document.getElementById('date-input').value;
            if(!dateVal) { alert("Vui l√≤ng ch·ªçn ng√†y!"); return; }
            document.getElementById('display-value').innerText = "...";
            document.getElementById('display-label').innerText = "ƒêang tra c·ª©u...";
            var data = { action: 'check_date', password: globalPassword, target_date: dateVal };

            fetch(GOOGLE_APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.result === "success") {
                    document.getElementById('display-value').innerText = formatK(result.total);
                    var parts = dateVal.split("-");
                    var niceDate = parts[2] + "/" + parts[1] + "/" + parts[0];
                    document.getElementById('display-label').innerText = "Doanh thu ng√†y " + niceDate;
                } else {
                    alert("L·ªói: " + result.msg);
                }
            });
        }

        function switchTab(type) {
            document.getElementById('tab-today').classList.remove('active');
            document.getElementById('tab-month').classList.remove('active');
            document.getElementById('tab-year').classList.remove('active');
            document.getElementById('tab-custom').classList.remove('active');
            document.getElementById('tab-' + type).classList.add('active');

            var displayValue = document.getElementById('display-value');
            var displayLabel = document.getElementById('display-label');
            var datePicker = document.getElementById('date-picker-area');

            if (type === 'custom') {
                datePicker.style.display = 'flex';
                displayValue.innerText = "---";
                displayLabel.innerText = "Ch·ªçn ng√†y ƒë·ªÉ xem";
                displayValue.style.color = "#ff9800";
                return; 
            } else {
                datePicker.style.display = 'none';
            }

            if (type === 'today') {
                displayValue.innerText = formatK(currentStats.today);
                displayLabel.innerText = "Doanh thu H√¥m nay";
                displayValue.style.color = "#1565c0"; 
            } else if (type === 'month') {
                displayValue.innerText = formatK(currentStats.month);
                displayLabel.innerText = "Doanh thu Th√°ng n√†y";
                displayValue.style.color = "#2e7d32"; 
            } else if (type === 'year') {
                displayValue.innerText = formatK(currentStats.year);
                displayLabel.innerText = "Doanh thu NƒÉm nay";
                displayValue.style.color = "#c62828"; 
            }
        }
    </script>
</body>
</html>